{
  "version": 3,
  "sources": ["../../langchain/dist/util/chunk.js", "../../langchain/dist/embeddings/base.js", "../../langchain/dist/embeddings/openai.js"],
  "sourcesContent": ["export const chunkArray = (arr, chunkSize) => arr.reduce((chunks, elem, index) => {\n    const chunkIndex = Math.floor(index / chunkSize);\n    const chunk = chunks[chunkIndex] || [];\n    // eslint-disable-next-line no-param-reassign\n    chunks[chunkIndex] = chunk.concat([elem]);\n    return chunks;\n}, []);\n", "import { AsyncCaller } from \"../util/async_caller.js\";\n/**\n * An abstract class that provides methods for embedding documents and\n * queries using LangChain.\n */\nexport class Embeddings {\n    constructor(params) {\n        /**\n         * The async caller should be used by subclasses to make any async calls,\n         * which will thus benefit from the concurrency and retry logic.\n         */\n        Object.defineProperty(this, \"caller\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        this.caller = new AsyncCaller(params ?? {});\n    }\n}\n", "import { OpenAI as OpenAIClient } from \"openai\";\nimport { getEnvironmentVariable } from \"../util/env.js\";\nimport { chunkArray } from \"../util/chunk.js\";\nimport { Embeddings } from \"./base.js\";\nimport { getEndpoint } from \"../util/azure.js\";\nimport { wrapOpenAIClientError } from \"../util/openai.js\";\n/**\n * Class for generating embeddings using the OpenAI API. Extends the\n * Embeddings class and implements OpenAIEmbeddingsParams and\n * AzureOpenAIInput.\n */\nexport class OpenAIEmbeddings extends Embeddings {\n    constructor(fields, configuration) {\n        const fieldsWithDefaults = { maxConcurrency: 2, ...fields };\n        super(fieldsWithDefaults);\n        Object.defineProperty(this, \"modelName\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: \"text-embedding-ada-002\"\n        });\n        Object.defineProperty(this, \"batchSize\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: 512\n        });\n        Object.defineProperty(this, \"stripNewLines\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: true\n        });\n        Object.defineProperty(this, \"timeout\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        Object.defineProperty(this, \"azureOpenAIApiVersion\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        Object.defineProperty(this, \"azureOpenAIApiKey\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        Object.defineProperty(this, \"azureOpenAIApiInstanceName\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        Object.defineProperty(this, \"azureOpenAIApiDeploymentName\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        Object.defineProperty(this, \"azureOpenAIBasePath\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        Object.defineProperty(this, \"client\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        Object.defineProperty(this, \"clientConfig\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        let apiKey = fieldsWithDefaults?.openAIApiKey ??\n            getEnvironmentVariable(\"OPENAI_API_KEY\");\n        const azureApiKey = fieldsWithDefaults?.azureOpenAIApiKey ??\n            getEnvironmentVariable(\"AZURE_OPENAI_API_KEY\");\n        if (!azureApiKey && !apiKey) {\n            throw new Error(\"OpenAI or Azure OpenAI API key not found\");\n        }\n        const azureApiInstanceName = fieldsWithDefaults?.azureOpenAIApiInstanceName ??\n            getEnvironmentVariable(\"AZURE_OPENAI_API_INSTANCE_NAME\");\n        const azureApiDeploymentName = (fieldsWithDefaults?.azureOpenAIApiEmbeddingsDeploymentName ||\n            fieldsWithDefaults?.azureOpenAIApiDeploymentName) ??\n            (getEnvironmentVariable(\"AZURE_OPENAI_API_EMBEDDINGS_DEPLOYMENT_NAME\") ||\n                getEnvironmentVariable(\"AZURE_OPENAI_API_DEPLOYMENT_NAME\"));\n        const azureApiVersion = fieldsWithDefaults?.azureOpenAIApiVersion ??\n            getEnvironmentVariable(\"AZURE_OPENAI_API_VERSION\");\n        this.azureOpenAIBasePath =\n            fieldsWithDefaults?.azureOpenAIBasePath ??\n                getEnvironmentVariable(\"AZURE_OPENAI_BASE_PATH\");\n        this.modelName = fieldsWithDefaults?.modelName ?? this.modelName;\n        this.batchSize =\n            fieldsWithDefaults?.batchSize ?? (azureApiKey ? 1 : this.batchSize);\n        this.stripNewLines =\n            fieldsWithDefaults?.stripNewLines ?? this.stripNewLines;\n        this.timeout = fieldsWithDefaults?.timeout;\n        this.azureOpenAIApiVersion = azureApiVersion;\n        this.azureOpenAIApiKey = azureApiKey;\n        this.azureOpenAIApiInstanceName = azureApiInstanceName;\n        this.azureOpenAIApiDeploymentName = azureApiDeploymentName;\n        if (this.azureOpenAIApiKey) {\n            if (!this.azureOpenAIApiInstanceName && !this.azureOpenAIBasePath) {\n                throw new Error(\"Azure OpenAI API instance name not found\");\n            }\n            if (!this.azureOpenAIApiDeploymentName) {\n                throw new Error(\"Azure OpenAI API deployment name not found\");\n            }\n            if (!this.azureOpenAIApiVersion) {\n                throw new Error(\"Azure OpenAI API version not found\");\n            }\n            apiKey = apiKey ?? \"\";\n        }\n        this.clientConfig = {\n            apiKey,\n            baseURL: configuration?.basePath,\n            dangerouslyAllowBrowser: true,\n            defaultHeaders: configuration?.baseOptions?.headers,\n            defaultQuery: configuration?.baseOptions?.params,\n            ...configuration,\n        };\n    }\n    /**\n     * Method to generate embeddings for an array of documents. Splits the\n     * documents into batches and makes requests to the OpenAI API to generate\n     * embeddings.\n     * @param texts Array of documents to generate embeddings for.\n     * @returns Promise that resolves to a 2D array of embeddings for each document.\n     */\n    async embedDocuments(texts) {\n        const batches = chunkArray(this.stripNewLines ? texts.map((t) => t.replace(/\\n/g, \" \")) : texts, this.batchSize);\n        const batchRequests = batches.map((batch) => this.embeddingWithRetry({\n            model: this.modelName,\n            input: batch,\n        }));\n        const batchResponses = await Promise.all(batchRequests);\n        const embeddings = [];\n        for (let i = 0; i < batchResponses.length; i += 1) {\n            const batch = batches[i];\n            const { data: batchResponse } = batchResponses[i];\n            for (let j = 0; j < batch.length; j += 1) {\n                embeddings.push(batchResponse[j].embedding);\n            }\n        }\n        return embeddings;\n    }\n    /**\n     * Method to generate an embedding for a single document. Calls the\n     * embeddingWithRetry method with the document as the input.\n     * @param text Document to generate an embedding for.\n     * @returns Promise that resolves to an embedding for the document.\n     */\n    async embedQuery(text) {\n        const { data } = await this.embeddingWithRetry({\n            model: this.modelName,\n            input: this.stripNewLines ? text.replace(/\\n/g, \" \") : text,\n        });\n        return data[0].embedding;\n    }\n    /**\n     * Private method to make a request to the OpenAI API to generate\n     * embeddings. Handles the retry logic and returns the response from the\n     * API.\n     * @param request Request to send to the OpenAI API.\n     * @returns Promise that resolves to the response from the API.\n     */\n    async embeddingWithRetry(request) {\n        if (!this.client) {\n            const openAIEndpointConfig = {\n                azureOpenAIApiDeploymentName: this.azureOpenAIApiDeploymentName,\n                azureOpenAIApiInstanceName: this.azureOpenAIApiInstanceName,\n                azureOpenAIApiKey: this.azureOpenAIApiKey,\n                azureOpenAIBasePath: this.azureOpenAIBasePath,\n                baseURL: this.clientConfig.baseURL,\n            };\n            const endpoint = getEndpoint(openAIEndpointConfig);\n            const params = {\n                ...this.clientConfig,\n                baseURL: endpoint,\n                timeout: this.timeout,\n                maxRetries: 0,\n            };\n            if (!params.baseURL) {\n                delete params.baseURL;\n            }\n            this.client = new OpenAIClient(params);\n        }\n        const requestOptions = {};\n        if (this.azureOpenAIApiKey) {\n            requestOptions.headers = {\n                \"api-key\": this.azureOpenAIApiKey,\n                ...requestOptions.headers,\n            };\n            requestOptions.query = {\n                \"api-version\": this.azureOpenAIApiVersion,\n                ...requestOptions.query,\n            };\n        }\n        return this.caller.call(async () => {\n            try {\n                const res = await this.client.embeddings.create(request, requestOptions);\n                return res;\n            }\n            catch (e) {\n                const error = wrapOpenAIClientError(e);\n                throw error;\n            }\n        });\n    }\n}\n"],
  "mappings": "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",
  "names": []
}
